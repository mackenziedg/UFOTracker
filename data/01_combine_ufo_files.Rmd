---
title: "Process all the data"
output: html_notebook
---

Step 0: Read in libraries 

```{r, message=FALSE, warning=FALSE}
#rm(list=ls())
library(tidyverse)
#library(purrr)
library(data.table)
library(janitor)
library(noncensus)
library(zoo)
#library(plyr)

#library(lmtest)
#library(plyr)
#library(tidyverse)
#library(ggplot2)
#library(ggrepel)
#library(GGally)
#library(lubridate)
```


Step 2: Read in files
```{r}
my.directory <- "~/Google Drive/stat/UFOTracker/data"
# setwd(my.directory)
setwd("~/Google Drive/stat/UFOTracker/data")
beer.path <- "raw/brew_count_by_state_1984_2017.csv"
movies.path <- "raw/alien_movies_per_year.csv"
gdp.path<- "raw/gdp_per_capita_per_year.csv"
internet.rurality.path <- "raw/internet_by_rurality.csv"
usafbase.path <- "raw/usaf_base_locs.csv"
statepops.path <- "raw/state_pops.csv"
sightings.path <- "raw/ufo_sightings.csv"
allmovies.path <- "raw/number_of_movies_per_year.csv"
statepops3.path <- "raw/statepops.db3.csv"


beer.raw <- fread(file.path(my.directory, beer.path), header=TRUE, na.strings=c("*", ""))

sightings.raw <- fread(file.path(my.directory, sightings.path), header = TRUE, na.strings = c("", "Unknown", "--"))

movies.raw <- fread(file.path(my.directory, movies.path), header = TRUE)

gdp.raw <- fread(file.path(my.directory, gdp.path), header = TRUE)

internet.rurality.raw <- fread(file.path(my.directory, internet.rurality.path), header = TRUE)

usafbase.raw <- fread(file.path(my.directory, usafbase.path), header = TRUE, na.strings = c(""))

statepops.raw <- fread(file.path(my.directory, statepops.path), header = TRUE)

#all_movies <- read.csv(file = "../../data/raw/number_of_movies_per_year.csv", head = TRUE)
allmovies.raw <- fread(file.path(my.directory, allmovies.path), header = TRUE)

statepops3.raw <- read_csv(file.path(my.directory, statepops3.path))


```


Step 3: Data cleaning  

```{r}
# clean up file
beer.db <- beer.raw %>% 
  filter(!is.na(STATE)) %>%
  filter(STATE != "Total") %>% 
  filter(STATE != "Other") %>% 
  filter(STATE != "* No reportable data") %>% 
  filter(STATE != "Â«This list will be updated quarterly.") %>% 
  rename(state = STATE) %>% 
  mutate(state = as.factor(state)) %>%
  gather_("year", "breweries", as.character(seq(1984, 2017))) %>%
  mutate(breweries = as.numeric(breweries)) %>%
  filter(year >= 1984) %>%
  filter(year <= 2016) %>%
  # filter(state == "FL") %>%
  mutate(year = as.numeric(year))
  
```

Group the states into regions.   
```{r}
data(states)
```

```{r}
# x = statepops.db$year 
# x - (x %% 10)
```

```{r}
statepops.db <- statepops.raw %>% 
  #gather_("Name", "year", "population")
  gather_("year", "population", as.character(seq(1960,2010,10))) %>% 
  filter(Name %in% state.name) %>% 
  mutate(year = as.integer(year)) %>% 
  mutate(population = as.numeric(gsub(",", "", population)))
  # mutate(population = as.integer(population))
  # gsub(",", "", population)
  # mutate(population = as.numeric(gsub(",", "", population))
  
```


```{r}
statepops.db2 <- statepops.raw %>% 
  filter(Name %in% state.name)  

statepops.db3 <- data.frame(t(statepops.db2))
```

```{r}
library(datetime)
yrs <- 1970:2016
yrs <- zoo(NA, as.year(yrs))

zpops <- zoo(select(statepops3.raw, -year), as.year(statepops3.raw$year))

z <- merge(yrs, zpops)
z <- z[,colnames(z) != "yrs"]
interps <- na.spline(z)
```


```{r}
sightings.db <- sightings.raw %>% 
  #filter(state=='FL') %>% 
  mutate(state = toupper(state)) %>% 
  mutate(year = as.numeric(format(as.Date(date_time, format="%m/%d/%y"),"%Y"))) %>% 
  filter(state %in% state.abb) %>% 
  filter(year >= 1974) %>% 
  filter(year <= 2016) %>%
  count(year, state) %>% 
  rename(num_sightings = n) %>%
  left_join(states, by = c("state" = "state")) %>%
  select(-area, -population, -division, -capital) %>%
  mutate(decade = year - (year %% 10))

```

### Normalize the number of sightings by the population of each state df$sightings_per_thousand <- (df$sightings / df$pop) * 1000
```{r}
sightings.db2 <- sightings.db %>% 
  left_join(statepops.db, by = c("decade" = "year", "name" = "Name")) %>% 
  mutate(sightings_per_100k = ((num_sightings/population) * 100000)) %>% 
  select(year, state, region, sightings_per_100k)

```






```{r}
# statepops.raw$Name <- mapvalues(statepops.raw$Name, state.name, state.abb)
# state_pops <- statepops.raw %>%
#     filter(Name %in% state.abb) %>%
#     select(one_of(c("1970", "1980", "1990", "2000", "2010"))) %>%
#     apply(1, mean)
```











# Normalize Movies By Total Movies That Year
```{r}
#all_movies <- allmovies.raw[nrow(allmovies.raw):1,]
allmovies.raw %>% 
  filter(year >= 1974) %>% 
  filter(year <= 2016)

```

divide number of alien mobies that year divide by total box office movies that came out that year.

The number is small, so interepretability may be an issue here. Careful!  
```{r}
movies.db <- movies.raw %>% 
  filter(year >= 1974) %>% 
  filter(year <= 2016) %>% 
  left_join(allmovies.raw, by=c("year"="year")) %>% 
  mutate(alienmovies_per_year = num_movies/total_movies) %>% 
  select(year, alienmovies_per_year)
```








```{r}
gdp.db <- gdp.raw %>% 
  clean_names() %>% 
  rename(year = year_and_category) %>% 
  filter(year >= 1974) %>% 
  select(year, per_capita_gdp_current)
```

```{r}
internet.rurality.db <- internet.rurality.raw %>% 
  rename(year = Year)
```

```{r}
usafbase.db <- usafbase.raw %>% 
  #filter(State == "FL") %>% 
  # rename(state = State) %>% 
  group_by(State) %>%
  count() %>%
  merge(state.abb, by.x="State", by.y=1, all=T) %>%
  mutate(n=replace(n, is.na(n), 0)) %>%
  filter(!is.na(State)) %>% 
  rename(afbase_per_state = n) %>% 
  rename(state = State)
``` 







Join files together
```{r}
all.states.normalized.df <- sightings.db2 %>% 
  left_join(beer.db, by=c("year" = "year", "state"= "state")) %>% 
  left_join(movies.db, by = c("year" = "year")) %>% 
  left_join(gdp.db, by = c("year" = "year")) %>%
  left_join(internet.rurality.db, by=c("year" = "year")) %>% 
  left_join(usafbase.db, by=c("state" = "state"))
```


```{r}
#left_join(sightings.db, by=c("year" = "year", "state = state")) %>% 
  #left_join(beer.db, by=c("year" = "year", "state =  state")) %>% 


# older parts of dataframe reserved only for chooisng one state
#mutate(state = ifelse(is.na(state), "FL", "FL"))
```


Step 4: Write out
```{r}
write_csv(all.states.normalized.df, "raw/all_states_normalized.csv")
```



```{r}
write_csv(statepops.db3, "raw/statepops.db3.csv")
```

